@page
@model Customer_Relationship_Management.Pages.Admin.Account.ManageUserModel
@{
    Layout = "_LayoutAdmin";
    ViewData["Title"] = "Quản lý Tài khoản";
}

<style>
    .admin-gradient-heading {
        background: linear-gradient(90deg, #2f3542 0%, #58606c 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: bold;
        font-size: 2rem;
        letter-spacing: -0.5px;
    }

    .btn-admin-gradient {
        background: linear-gradient(180deg, #2f3542 0%, #58606c 100%);
        color: #fff !important;
        border: none;
        transition: .3s;
    }

    .btn-admin-outline {
        background: transparent;
        color: #2f3542 !important;
        border: 1px solid #58606c;
    }

    .glass-card-admin {
        backdrop-filter: blur(8px);
        background: rgba(47,53,66,0.07);
        border-radius: 14px;
        padding: 0;
        border: 1px solid #eee;
    }

    .table-card-admin {
        background: #fff;
        border-radius: .75rem;
        box-shadow: 0 1px 8px rgba(44,62,80,0.07);
    }

    .admin-table-striped tbody tr:nth-child(odd) {
        background-color: #f5f7fa !important;
    }

    .form-label {
        font-weight: 600;
        color: #58606c !important;
    }

    .form-control, .form-select {
        border-radius: 8px;
    }

    .mgr-error {
        color: #d9534f;
        font-size: .9rem;
    }

    .filter-card {
        background: #fff;
        border-radius: .75rem;
        box-shadow: 0 1px 8px rgba(0,0,0,.06);
    }

    .badge-admin {
        background: #2f3542;
        color: #fff;
        font-size: .7rem;
        padding: .35rem .5rem;
        border-radius: 6px;
    }
</style>

<div class="container-fluid px-3 py-4 animate__animated animate__fadeIn">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="admin-gradient-heading mb-0">Quản lý Tài khoản</h2>
            <p class="text-muted mb-0 small">Quản trị, tìm kiếm, cấp quyền và khóa tài khoản người dùng hệ thống</p>
        </div>
    </div>

    <!-- CREATE USER FORM -->
    <div class="card glass-card-admin mb-4 border-0 shadow-sm">
        <div class="card-body">
            <h5 class="mb-3">Tạo người dùng mới</h5>
            <form method="post" asp-page-handler="Create" id="createUserForm" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Username</label>
                    <input class="form-control" asp-for="CreateInput.Username" required />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" asp-for="CreateInput.Email" required />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Họ tên</label>
                    <input class="form-control" asp-for="CreateInput.FullName" required />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Số điện thoại</label>
                    <input class="form-control" asp-for="CreateInput.Phone" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Vai trò</label>
                    <select class="form-select" asp-for="CreateInput.RoleID" id="roleSelect" required>
                        <option value="">-- Chọn vai trò --</option>
                        <option value="1">Employee</option>
                        <option value="2">Manager</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Quản lý trực tiếp (bắt buộc nếu Employee)</label>
                    <select class="form-select" asp-for="CreateInput.ManagerID" id="managerSelect">
                        <option value="">-- Chọn Manager --</option>
                        @foreach (var m in Model.Managers)
                        {
                            <option value="@m.Id">@m.Display</option>
                        }
                    </select>
                    <div class="mgr-error d-none" id="mgrError">Nhân viên bắt buộc chọn Manager.</div>
                </div>

                <div class="col-12">
                    <button class="btn btn-admin-gradient">Tạo mới (mật khẩu mặc định: demo)</button>
                </div>
            </form>
        </div>
    </div>

    <!-- FILTER FORM -->
    <div class="card filter-card mb-4 p-3">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-2">
                <label class="form-label">UserCode</label>
                <input class="form-control" name="FilterUserCode" value="@Model.FilterUserCode" placeholder="Mã..." />
            </div>
            <div class="col-md-2">
                <label class="form-label">Username</label>
                <input class="form-control" name="FilterUsername" value="@Model.FilterUsername" placeholder="Tên..." />
            </div>
            <div class="col-md-2">
                <label class="form-label">Role</label>
                <select class="form-select" name="FilterRoleId">
                    <option value="">-- Tất cả --</option>
                    <option value="1" selected="@(Model.FilterRoleId == 1)">Employee</option>
                    <option value="2" selected="@(Model.FilterRoleId == 2)">Manager</option>
                    <option value="3" selected="@(Model.FilterRoleId == 3)">Admin</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Trạng thái khóa</label>
                <select class="form-select" name="FilterLocked">
                    <option value="">-- Tất cả --</option>
                    <option value="true" selected="@(Model.FilterLocked == true)">Đang khóa</option>
                    <option value="false" selected="@(Model.FilterLocked == false)">Không khóa</option>
                </select>
            </div>
            <!-- CHỈ SỬA DÒNG NÀY: bỏ flex-grow-1 để nút Lọc không kéo dài -->
            <div class="col-md-4 d-flex gap-2">
                <button type="submit" class="btn btn-admin-gradient">Lọc</button>
                <a class="btn btn-admin-outline" href="@Url.Page("/Admin/Account/ManageUser")">Đặt lại</a>
            </div>
        </form>
        <div class="small text-muted mt-2">
            Tổng số: @Model.Users.Count()
        </div>
    </div>

    @if (TempData["Error"] is string err)
    {
        <div class="alert alert-danger">@err</div>
    }
    @if (TempData["Success"] is string ok)
    {
        <div class="alert alert-success">@ok</div>
    }

    <!-- USERS TABLE -->
    <div class="table-responsive table-card-admin card p-3">
        <table class="table admin-table-striped align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Mã</th>
                    <th>Username</th>
                    <th>Họ tên</th>
                    <th>Role</th>
                    <th>Manager</th>
                    <th>Trạng thái</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var u in Model.Users)
                {
                    bool isAdmin = string.Equals(u.RoleName, "Admin", StringComparison.OrdinalIgnoreCase) || u.RoleID == 3;
                    <tr>
                        <td>@u.UserCode</td>
                        <td>@u.Username</td>
                        <td>@u.FullName</td>

                        <td>
                            @if (isAdmin)
                            {
                                <span>@u.RoleName <span class="badge-admin">Admin</span></span>
                            }
                            else
                            {
                                <form method="post" asp-page-handler="UpdateRole" class="d-flex gap-2 align-items-center js-confirm"
                                      data-title="Cập nhật Role?"
                                      data-text="Xác nhận đổi role cho @u.Username?"
                                      data-icon="question"
                                      data-confirm="#58606c">
                                    <input type="hidden" name="UpdateRole.UserID" value="@u.UserID" />
                                    <select class="form-select form-select-sm" name="UpdateRole.RoleID" style="min-width:160px" @(u.IsDeleted ? "disabled" : "")>
                                        <option value="1" selected="@(u.RoleID == 1)">Employee</option>
                                        <option value="2" selected="@(u.RoleID == 2)">Manager</option>
                                    </select>
                                    <button class="btn btn-sm btn-admin-gradient" @(u.IsDeleted ? "disabled" : "")>Lưu</button>
                                </form>
                            }
                        </td>

                        <td>
                            @if (!isAdmin && u.RoleName == "Employee" && !u.IsDeleted)
                            {
                                <form method="post" asp-page-handler="UpdateManager" class="d-flex gap-2 align-items-center js-confirm"
                                      data-title="Cập nhật Manager?"
                                      data-text="Xác nhận đổi Manager cho @u.Username?"
                                      data-icon="info"
                                      data-confirm="#58606c">
                                    <input type="hidden" name="UpdateMgr.UserID" value="@u.UserID" />
                                    <select class="form-select form-select-sm" name="UpdateMgr.ManagerID" style="min-width: 240px;">
                                        <option value="">-- Chọn Manager --</option>
                                        @foreach (var m in Model.Managers)
                                        {
                                            <option value="@m.Id" selected="@(u.ManagerID == m.Id)">@m.Display</option>
                                        }
                                    </select>
                                    <button class="btn btn-sm btn-admin-gradient">Lưu</button>
                                </form>
                            }
                            else if (u.RoleName == "Employee" && u.IsDeleted)
                            {
                                <span class="text-muted small">Đã xóa</span>
                            }
                        </td>

                        <td>@(u.IsDeleted ? "Đã xóa" : u.Status)</td>

                        <td class="text-end">
                            @if (isAdmin)
                            {
                                <span class="text-muted small">Admin - không quản lý</span>
                            }
                            else if (u.IsDeleted)
                            {
                                <span class="small text-muted">Tài khoản đã xóa</span>
                            }
                            else
                            {
                                <form method="post" asp-page-handler="ToggleDelete" asp-route-id="@u.UserID"
                                      class="d-inline js-confirm"
                                      data-title="@(u.Status == "Locked" ? "Mở khóa tài khoản?" : "Khóa tài khoản?")"
                                      data-text="@(u.Status == "Locked" ? $"Mở khóa {u.Username}?" : $"Khóa {u.Username}?")"
                                      data-icon="warning"
                                      data-confirm="@(u.Status == "Locked" ? "#2f3542" : "#dc3545")">
                                    @if (string.Equals(u.Status, "Locked", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <button type="submit" class="btn btn-sm btn-admin-gradient">Unlock</button>
                                    }
                                    else
                                    {
                                        <button type="submit" class="btn btn-sm btn-danger">Lock</button>
                                    }
                                </form>

                                <form method="post" asp-page-handler="ForceChange" asp-route-id="@u.UserID"
                                      class="d-inline js-confirm"
                                      data-title="Yêu cầu đổi mật khẩu?"
                                      data-text="Bắt buộc @u.Username đổi mật khẩu khi đăng nhập?"
                                      data-icon="info"
                                      data-confirm="#ffc107">
                                    <button class="btn btn-sm btn-warning">Require PW Change</button>
                                </form>

                                <form method="post" asp-page-handler="Delete" asp-route-id="@u.UserID"
                                      class="d-inline js-confirm"
                                      data-title="Xóa người dùng này?"
                                      data-text="Bạn chắc chắn muốn xóa @u.Username? Thao tác này sẽ khóa vĩnh viễn tài khoản."
                                      data-icon="error"
                                      data-confirm="#dc3545">
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Create form: require Manager when Role == Employee (1)
        document.getElementById('createUserForm')?.addEventListener('submit', function (e) {
            const role = document.getElementById('roleSelect')?.value;
            const mgr = document.getElementById('managerSelect')?.value;
            const err = document.getElementById('mgrError');
            if (role === '1' && !mgr) {
                e.preventDefault();
                err?.classList.remove('d-none');
            } else {
                err?.classList.add('d-none');
            }
        });

        // toggle required attribute when role changes
        document.getElementById('roleSelect')?.addEventListener('change', function () {
            const needMgr = this.value === '1';
            const mgrSelect = document.getElementById('managerSelect');
            if (needMgr) {
                mgrSelect?.setAttribute('required', 'required');
            } else {
                mgrSelect?.removeAttribute('required');
            }
        });

        // SweetAlert2 confirmation
        document.addEventListener('submit', function (e) {
            const form = e.target.closest('.js-confirm');
            if (!form) return;

            e.preventDefault();
            const title = form.dataset.title || 'Bạn chắc chắn?';
            const text = form.dataset.text || '';
            const icon = form.dataset.icon || 'question';
            const confirmColor = form.dataset.confirm || '#58606c';

            Swal.fire({
                title, text, icon,
                showCancelButton: true,
                confirmButtonText: 'Xác nhận',
                cancelButtonText: 'Hủy',
                confirmButtonColor: confirmColor,
                cancelButtonColor: '#6c757d'
            }).then(r => { if (r.isConfirmed) form.submit(); });
        });
    </script>
}