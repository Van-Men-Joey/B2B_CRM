@page "{status?}/{id?}"
@model Customer_Relationship_Management.Pages.Manager.Contract.IndexModel
@{
    ViewData["Title"] = "Quản lý hợp đồng";
    ViewData["ActiveMenu"] = "Contracts";
    Layout = "_LayoutManager";
}

<div class="container-fluid py-4 px-3 animate__animated animate__fadeIn">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-gradient-mgr mb-0">Quản lý Hợp đồng</h2>
            <p class="text-muted mb-0 small">Duyệt, theo dõi trạng thái và tìm kiếm hợp đồng</p>
        </div>
    </div>

    <form method="get" class="card glass-card border-0 shadow-sm mb-4">
        <input type="hidden" name="status" value="@Model.CurrentStatus" />
        <div class="card-body row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label fw-semibold">Từ ngày</label>
                <input type="date" name="FromDate" value="@Model.FromDate?.ToString("yyyy-MM-dd")" class="form-control shadow-sm" />
            </div>
            <div class="col-md-3">
                <label class="form-label fw-semibold">Đến ngày</label>
                <input type="date" name="ToDate" value="@Model.ToDate?.ToString("yyyy-MM-dd")" class="form-control shadow-sm" />
            </div>
            <div class="col-md-6">
                <label class="form-label fw-semibold">Tìm kiếm</label>
                <input type="text" name="Keyword" value="@Model.Keyword" placeholder="Tên deal, người tạo hoặc nội dung hợp đồng..." class="form-control shadow-sm" />
            </div>
            <div class="col-12 d-flex justify-content-end">
                <button type="submit" class="btn btn-gradient-mgr px-4">Lọc</button>
                <a asp-page="./Index" asp-route-status="@Model.CurrentStatus" class="btn btn-gradient-mgr px-4 ms-2">Đặt lại</a>
            </div>
        </div>
    </form>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">@TempData["SuccessMessage"]</div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
    }

    @if (Model.Contracts.Any())
    {
        <div class="table-responsive card table-card p-3">

            <!-- Dải tiêu đề bảng: gradient xanh lá giống heading Manager -->
            <div class="table-title-band table-title-band-mgr mb-2">
                <div class="fw-semibold">Danh sách hợp đồng</div>
                <small class="opacity-75">Theo dõi tiến độ duyệt và thanh toán</small>
            </div>

            <table class="table table-hover align-middle text-dark bg-white" id="contractsTable">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Deal</th>
                        <th>Người tạo</th>
                        <th>Trạng thái</th>
                        <th>Ngày tạo</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var contract in Model.Contracts)
                    {
                        <tr>
                            <td>@contract.ContractID</td>
                            <td>@contract.Deal?.DealName</td>
                            <td>@contract.CreatedBy?.FullName</td>
                            <td>@contract.ApprovalStatus</td>
                            <td>@contract.CreatedAt.ToString("dd/MM/yyyy")</td>
                            <td>
                                <a class="btn btn-sm btn-outline-info"
                                   asp-page="./Index"
                                   asp-route-status="@Model.CurrentStatus"
                                   asp-route-id="@contract.ContractID">
                                    Xem
                                </a>

                                @if (Model.CurrentStatus == "Pending")
                                {
                                    <form method="post" asp-page-handler="Approve" style="display:inline">
                                        <input type="hidden" name="id" value="@contract.ContractID" />
                                        <input type="hidden" name="status" value="@Model.CurrentStatus" />
                                        <input type="hidden" name="selectedId" value="@contract.ContractID" />
                                        <button type="button"
                                                class="btn btn-sm btn-success js-confirm"
                                                data-title="Phê duyệt hợp đồng?"
                                                data-text="Bạn chắc chắn muốn phê duyệt hợp đồng #@contract.ContractID?"
                                                data-icon="question"
                                                data-confirm="#198754">
                                            Duyệt
                                        </button>
                                    </form>
                                    <form method="post" asp-page-handler="Reject" style="display:inline">
                                        <input type="hidden" name="id" value="@contract.ContractID" />
                                        <input type="hidden" name="status" value="@Model.CurrentStatus" />
                                        <input type="hidden" name="selectedId" value="@contract.ContractID" />
                                        <button type="button"
                                                class="btn btn-sm btn-danger js-confirm"
                                                data-title="Từ chối hợp đồng?"
                                                data-text="Bạn chắc chắn muốn từ chối hợp đồng #@contract.ContractID?"
                                                data-icon="warning"
                                                data-confirm="#dc3545">
                                            Từ chối
                                        </button>
                                    </form>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <p class="text-muted">Không có hợp đồng nào cho bộ lọc này.</p>
    }
</div>

<!-- Modal Chi tiết giữ nguyên... -->
@section Styles {
    <style>
        .btn-gradient-mgr {
            background: linear-gradient(180deg,#198754 0%,#20c997 100%);
            color: #fff;
            border: none;
            transition: .3s
        }

            .btn-gradient-mgr:hover {
                transform: translateY(-1px);
                opacity: .95
            }

        .text-gradient-mgr {
            background: linear-gradient(180deg,#198754 0%,#20c997 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent
        }

        .glass-card {
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,.92);
            border-radius: 14px;
            color: #212529
        }

        .table-card {
            background: #fff;
            border-radius: .75rem
        }

        /* Dải tiêu đề bảng – cùng gradient với heading/nút Manager */
        .table-title-band {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: .6rem 1rem;
            color: #fff;
            border-radius: .5rem;
            font-weight: 700;
            line-height: 1.2;
            box-shadow: 0 3px 12px rgba(0,0,0,.08);
        }

        .table-title-band-mgr {
            background: linear-gradient(180deg,#198754 0%,#20c997 100%);
            box-shadow: 0 3px 12px rgba(25,135,84,.25);
        }

        .modal-content {
            background: #fff;
            color: #212529
        }
    </style>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const hasDetails = '@(Model.SelectedContract != null ? "true" : "false")' === 'true';
            if (hasDetails) {
                const modalEl = document.getElementById('detailsModal');
                bootstrap.Modal.getOrCreateInstance(modalEl).show();
            }
        });

        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.js-confirm');
            if (!btn) return;
            e.preventDefault();
            const form = btn.closest('form');
            Swal.fire({
                title: btn.dataset.title || 'Xác nhận?',
                text: btn.dataset.text || 'Bạn chắc chắn?',
                icon: btn.dataset.icon || 'question',
                showCancelButton: true,
                confirmButtonText: 'Xác nhận',
                cancelButtonText: 'Hủy',
                confirmButtonColor: btn.dataset.confirm || '#198754',
                cancelButtonColor: '#6c757d'
            }).then(r => { if (r.isConfirmed) form.submit(); });
        });
    </script>
}