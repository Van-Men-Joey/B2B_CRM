@page
@model Customer_Relationship_Management.Pages.Manager.Customer.IndexModel
@{
    ViewData["Title"] = "Quản lý khách hàng";
    Layout = "_LayoutManager";
}

<div class="container-fluid py-4 px-3 animate__animated animate__fadeIn">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-gradient-mgr mb-0">Quản lý Khách hàng</h2>
            <p class="text-muted mb-0 small">Theo dõi khách hàng, trạng thái VIP và gán Sales phụ trách</p>
        </div>
    </div>

    <!-- Bộ lọc tìm kiếm -->
    <form method="get" class="card glass-card border-0 shadow-sm mb-4">
        <div class="card-body row g-3 align-items-end">
            <div class="col-md-9">
                <label class="form-label fw-semibold">Tìm kiếm</label>
                <input name="SearchTerm"
                       value="@Model.SearchTerm"
                       placeholder="Tên công ty, email, số điện thoại..."
                       class="form-control shadow-sm" />
            </div>
            <div class="col-md-3 d-flex gap-2 justify-content-end">
                <button type="submit" class="btn btn-gradient-mgr px-4">Tìm</button>
                <a asp-page="./Index" class="btn btn-gradient-mgr px-4">Đặt lại</a>
            </div>
        </div>
    </form>

    <!-- Stats -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-lg-3">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <div class="text-muted small">Tổng khách</div>
                    <div class="fs-3 fw-bold">@Model.TotalCustomers</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <div class="text-muted small">VIP</div>
                    <div class="fs-3 fw-bold text-warning">@Model.TotalVIP</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <div class="text-muted small">Số Deal</div>
                    <div class="fs-3 fw-bold">@Model.TotalDeals</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <div class="text-muted small">Tổng giá trị</div>
                    <div class="fs-4 fw-bold text-success">@String.Format("{0:N0}", Model.TotalDealValue)</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="table-responsive card table-card p-3">
        <table class="table table-hover align-middle text-dark bg-white">
            <thead class="table-light">
                <tr>
                    <th>Công ty</th>
                    <th>Ngành</th>
                    <th class="text-center">VIP</th>
                    <th class="text-center">Deal</th>
                    <th class="text-end">Giá trị</th>
                    <th class="text-center">Sales</th>
                    <th class="text-center">Hành động</th>
                </tr>
            </thead>
            <tbody>
            @if (Model.Customers?.Any() == true)
            {
                foreach (var c in Model.Customers)
                {
                    <tr>
                        <td class="fw-semibold">@c.CompanyName</td>
                        <td>@c.Industry</td>
                        <td class="text-center">
                            <button type="button"
                                    class="btn btn-sm @(c.VIP ? "btn-warning text-dark" : "btn-outline-secondary")"
                                    onclick="openVipModal(@c.CustomerID, @c.VIP.ToString().ToLower())">
                                @(c.VIP ? "VIP" : "Không")
                            </button>
                        </td>
                        <td class="text-center">@c.DealsCount</td>
                        <td class="text-end fw-semibold">@String.Format("{0:N0}", c.DealsValue)</td>
                        <td class="text-center">
                            <form method="post" asp-page-handler="AssignEmployee" class="d-inline-flex gap-2 align-items-center">
                                <input type="hidden" name="AssignCustomerId" value="@c.CustomerID" />
                                <select name="SelectedEmployeeId" class="form-select form-select-sm shadow-sm" style="min-width: 180px">
                                    <option value="">-- Chọn --</option>
                                    @foreach (var emp in Model.Employees)
                                    {
                                        <option value="@emp.UserID" selected="@(emp.UserID == c.AssignedToUserID)">@emp.FullName</option>
                                    }
                                </select>
                                <button class="btn btn-sm btn-gradient-mgr">Gán</button>
                            </form>
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn btn-link text-success p-0 me-2" onclick="openDetail(@c.CustomerID)">Chi tiết</button>
                            |
                            <a class="btn btn-link text-primary p-0 ms-2" asp-page="/Manager/Customer/Edit" asp-route-id="@c.CustomerID">Sửa</a>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr><td colspan="7" class="text-center text-muted py-4">Không có khách hàng.</td></tr>
            }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-between align-items-center mt-3 text-muted small">
        <span>Trang @Model.PageNumber / @Model.TotalPages — @Model.TotalCustomers khách</span>
        <div class="d-flex gap-2">
            <a asp-page="./Index" asp-route-PageNumber="@(Model.PageNumber - 1)"
               class="btn btn-sm btn-outline-secondary @(Model.PageNumber <= 1 ? "disabled" : "")">Trước</a>
            @for (int p = 1; p <= Model.TotalPages; p++)
            {
                <a asp-page="./Index" asp-route-PageNumber="@p"
                   class="btn btn-sm @(p == Model.PageNumber ? "btn-warning text-dark" : "btn-outline-secondary")">@p</a>
            }
            <a asp-page="./Index" asp-route-PageNumber="@(Model.PageNumber + 1)"
               class="btn btn-sm btn-outline-secondary @(Model.PageNumber >= Model.TotalPages ? "disabled" : "")">Tiếp</a>
        </div>
    </div>
</div>

<!-- Modal: VIP -->
<div class="modal fade" id="vipModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cập nhật trạng thái VIP</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="vipModalLabel" class="mb-0"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
                <form method="post" asp-page-handler="ToggleVIP" class="m-0">
                    <input type="hidden" id="vipCustomerId" name="VipCustomerId" />
                    <button type="submit" class="btn btn-gradient-mgr">Xác nhận</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Chi tiết -->
<div class="modal fade" id="customerDetailModal" tabindex="-1" aria-labelledby="customerDetailLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerDetailLabel">Chi tiết khách hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="detailContent" class="row g-3"></div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        /* Reuse the manager gradient style */
        .btn-gradient-mgr {
            background: linear-gradient(180deg, #198754 0%, #20c997 100%);
            color: #fff; border: none; transition: .3s;
        }
        .btn-gradient-mgr:hover { transform: translateY(-1px); opacity: .95; }

        .text-gradient-mgr {
            background: linear-gradient(180deg, #198754 0%, #20c997 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .glass-card { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.92); border-radius: 14px; color: #212529; }
        .table-card { background: #fff; border-radius: .75rem; }
    </style>
}

@section Scripts {
    <script>
        // VIP modal
        function openVipModal(id, vip) {
            document.getElementById("vipCustomerId").value = id;
            const msg = vip
                ? "Bạn có chắc muốn <strong>hủy VIP</strong> cho khách hàng này không?"
                : "Bạn có muốn <strong>đặt khách hàng này thành VIP</strong> không?";
            document.getElementById("vipModalLabel").innerHTML = msg;
            bootstrap.Modal.getOrCreateInstance(document.getElementById('vipModal')).show();
        }

        // Detail modal
        function openDetail(id) {
            const data = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Customers));
            const c = data.find(x => x.CustomerID === id);
            if (!c) return;

            const html = `
                <div class="col-12">
                    <div class="p-3 rounded bg-light">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="fw-bold fs-5 mb-1">${c.CompanyName}</div>
                                <div class="text-muted small">${c.Industry ?? "Không rõ ngành"}</div>
                            </div>
                            <div class="text-end">
                                <div class="small text-muted">Tổng giá trị</div>
                                <div class="fw-bold text-success">${(c.DealsValue || 0).toLocaleString()} VND</div>
                            </div>
                        </div>
                    </div>
                </div>
                ${detailItem("Liên hệ", c.ContactName)}
                ${detailItem("Email", c.ContactEmail)}
                ${detailItem("Số điện thoại", c.ContactPhone)}
                ${detailItem("Số Deal", c.DealsCount)}
                <div class="col-12">
                    <div class="p-3 rounded border bg-white">
                        <div class="fw-semibold">Trạng thái VIP:</div>
                        <div class="${c.VIP ? "text-warning fw-bold" : "text-muted"}">${c.VIP ? "VIP" : "Không"}</div>
                    </div>
                </div>
            `;
            document.getElementById("detailContent").innerHTML = html;
            bootstrap.Modal.getOrCreateInstance(document.getElementById('customerDetailModal')).show();
        }

        function detailItem(label, value) {
            const v = (value ?? "—");
            return `
                <div class="col-sm-6">
                    <div class="p-3 rounded border bg-white">
                        <div class="text-muted small mb-1">${label}</div>
                        <div class="fw-medium">${v}</div>
                    </div>
                </div>`;
        }
    </script>
}
